image: node:16.15

variables:
    HUGO_VERSION: '0.99.1'
    HUGO_CHECKSUM: 'f930fcc5559337233d24de3704a09b877a6cd29449241b69e111e10b24f6e200'
    HUGO_ENV: 'production'
    THEME: 'esteye-hugo-theme'

stages:
    - build
    - deploy

before_script:
    - apt update && apt install --no-install-recommends  -yqq curl
      ca-certificates git
    - corepack enable && npm install -g npm && pnpm add -g pnpm
    - npm install -g postcss postcss-cli
    - curl -L -o hugo.tar.gz
      https://github.com/gohugoio/hugo/releases/download/v$HUGO_VERSION/hugo_extended_$HUGO_VERSION\_Linux-64bit.tar.gz
    - echo "$HUGO_CHECKSUM  hugo.tar.gz" | sha256sum -c
    - tar xzvf hugo.tar.gz && cp ./hugo /usr/bin/hugo
    - hugo version

build:
    stage: build
    script:
        - pnpm install
        - hugo --minify -d public
    artifacts:
        paths:
            - public

deploy:
    stage: deploy
    script:
        - npm install -g netlify-cli
        - netlify deploy --prod -s $NETLIFY_SITE_ID -a $NETLIFY_ACCESS_TOKEN -d
          public
    only:
        - master
    dependencies:
        - build

pages:
    stage: deploy
    script: /bin/true
    only:
        - master
    artifacts:
        paths:
            - public
    dependencies:
        - build
